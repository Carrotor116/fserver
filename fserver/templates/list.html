<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1.0, minimum-scale=1.0"/>
    <title>Directory - {{ path }}</title>
    <style>
        /* ÂÖ®Â±ÄÊ†∑Âºè‰∏éÂ∏ÉÂ±Ä */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 24px 16px 32px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: #f5f7fb;
            color: #1f2933;
        }

        .page {
            max-width: 960px;
            margin: 0 auto;
        }

        h2 {
            margin: 0 0 8px;
            font-size: 22px;
            font-weight: 600;
            color: #111827;
        }

        .sub-path {
            font-size: 13px;
            color: #6b7280;
            word-break: break-all;
        }

        .card {
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
            padding: 16px 18px;
            margin-top: 18px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: #374151;
        }

        hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 16px -18px;
        }

        a {
            color: #2563eb;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* È°∂ÈÉ®ÊåâÈíÆÊ†∑ÂºèÔºàÊ®°Âºè & ÂäüËÉΩÔºâ */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 12px;
            align-items: center;
            margin-top: 12px;
        }

        .toolbar-label {
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
            margin-right: 4px;
        }

        .mode-btn {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            border: none;
            color: #ffffff;
            padding: 8px 14px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 999px;
            margin-left: 0;
            outline: none;
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(79, 70, 229, 0.25);
            transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, opacity 0.12s ease;
            white-space: nowrap;
        }

        .mode-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 14px 30px rgba(79, 70, 229, 0.35);
        }

        .mode-btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 8px 18px rgba(79, 70, 229, 0.25);
        }

        .mode-btn:disabled {
            opacity: 0.8;
            cursor: default;
        }

        .mode-btn.secondary {
            background: #f3f4ff;
            color: #4f46e5;
            box-shadow: none;
        }

        .mode-btn.secondary:hover:not(:disabled) {
            background: #e0e7ff;
            box-shadow: 0 6px 14px rgba(79, 70, 229, 0.15);
        }

        /* secondary ÊåâÈíÆÈÄöÁî®Á¶ÅÁî®ÊÄÅÔºàÁÅ∞Ëâ≤ÔºâÔºåÂåÖÊã¨ batch_down„ÄÅselect all Á≠â */
        .mode-btn.secondary:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            box-shadow: none;
        }

        /* ÂΩìÂâçÊøÄÊ¥ªÁöÑ mode ÊåâÈíÆÔºàÈÄöËøá disabled Ë°®Á§∫ÂΩìÂâçÊ®°ÂºèÔºâ */
        #mode .mode-btn.secondary:disabled {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: #ffffff;
            box-shadow: 0 8px 18px rgba(79, 70, 229, 0.25);
        }

        /* Â§Ñ‰∫é select Ê®°ÂºèÊó∂Ôºåmode Âå∫ÊåâÈíÆÁªü‰∏ÄÁÅ∞Ëâ≤Á¶ÅÁî®ÊÄÅÔºå‰∏éÂÖ∂‰ªñ secondary disabled Áä∂ÊÄÅ‰øùÊåÅ‰∏ÄËá¥ */
        body.select-mode #mode .mode-btn.secondary:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            box-shadow: none;
        }

        .mode-btn-icon {
            font-size: 14px;
        }

        {% if upload %}
        .file {
            position: relative;
            display: inline-block;
            background: #0ea5e9;
            border-radius: 999px;
            padding: 9px 16px;
            overflow: hidden;
            color: #ffffff;
            text-decoration: none;
            text-indent: 0;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 8px 18px rgba(14, 165, 233, 0.25);
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
        }

        .file:hover {
            background: #0284c7;
            box-shadow: 0 12px 26px rgba(14, 165, 233, 0.35);
            transform: translateY(-1px);
        }

        .file input {
            position: absolute;
            font-size: 16px;
            right: 0;
            font-weight: bold;
            top: 0;
            bottom: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        {% endif %}

        /* ÂàóË°®Ê†∑Âºè */
        #dir_ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .hide {
            display: none;
        }

        .check_box {
            height: 14px;
            width: 14px;
            margin: 0;
            padding: 0;
            display: inline-block;
            cursor: pointer;
        }

        li {
            min-height: 32px;
            list-style-type: none;
            white-space: nowrap;
            display: flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 6px;
            transition: background 0.12s ease, transform 0.08s ease;
        }

        li:nth-child(2n) {
            background-color: #f9fafb;
        }

        li:hover {
            background-color: #eef2ff;
            transform: translateX(1px);
        }

        .menu {
            white-space: nowrap;
            margin: 0;
        }

        .li_head {
            width: 32px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            text-align: center;
            margin-right: 4px;
        }

        .circle {
            display: none;
        }

        .file-name {
            font-size: 14px;
            color: #111827;
        }

        /* ‰∏ä‰º†ÂàóË°®Ê†∑Âºè */
        #file_ul {
            list-style: none;
            padding-left: 0;
            margin: 8px 0 0;
        }

        #file_ul li {
            background: #f9fafb;
            border-radius: 6px;
            padding: 6px 10px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            font-size: 13px;
        }

        #file_ul a {
            margin-right: 10px;
        }

        #file_ul span {
            font-size: 13px;
        }

        .upload-tip {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        @media (max-width: 640px) {
            .card {
                padding: 14px 12px;
            }

            .toolbar {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <h2>Directory listing</h2>
    <div class="sub-path">{{ path }}</div>

    <div class="card">
        <div class="card-header">
            <div class="card-title">Files & Folders</div>
        </div>
        <ul id="dir_ul">
    {% for l in list %}
        <li>
            <span class="li_head">
                <span class="circle"></span>
                <input class="hide" type="checkbox" name="cb" id="{{ l }}">
            </span>
            <a class="file-name" href="{{ l|urlencode + arg }}">{{ l }}</a>
        </li>
    {% endfor %}
</ul>
    </div>

    <div class="card">
        <div class="toolbar" id="mode">
            <span class="toolbar-label">mode</span>
            <button id="btn_normal" class="mode-btn secondary"><span class="mode-btn-icon">‚óè</span>normal</button>
            <button id="btn_txt" class="mode-btn secondary"><span class="mode-btn-icon">ùôè</span>display</button>
            <button id="btn_down" class="mode-btn secondary"><span class="mode-btn-icon">‚¨á</span>download</button>
            <button id="btn_play" class="mode-btn secondary"><span class="mode-btn-icon">‚ñ∂</span>play</button>
        </div>

        <div class="toolbar" style="margin-top: 10px;">
            <span class="toolbar-label">function</span>
            <button id="select_btn" class="mode-btn">select_on</button>
            <button id="batch_down" class="mode-btn secondary" disabled>batch_down</button>
            <button id="select_all_btn" class="mode-btn secondary" disabled>select all</button>
        </div>
    </div>


<script type="text/javascript">

    // init view status
    let btn_select = document.getElementById('select_btn')
    let lis = document.getElementsByClassName('li_head')
    let btns_mode = document.getElementById('mode').children
    let btn_select_all = document.getElementById('select_all_btn')
    let btn_batch_down = document.getElementById('batch_down')
    let links = document.getElementsByTagName('a')

    btn_select.onclick = function () {
        let select_on = btn_select.innerText === 'select_on'
        btn_select.innerText = select_on ? 'select_off' : 'select_on'
        for (let ele of lis) {
            ele.children[0].setAttribute('class', select_on ? 'hide' : 'circle')
            ele.children[1].setAttribute('class', select_on ? 'check_box' : 'hide')
        }
        btn_batch_down.disabled = !select_on
        btn_select_all.disabled = !select_on;
        for (let ele of btns_mode) {
            ele.disabled = select_on
        }
        // Êõ¥Êñ∞ mode ÊøÄÊ¥ªÊåâÈíÆÁä∂ÊÄÅ
        document.getElementById('btn_' + get_mode()).disabled = true
        // ‰∏∫ body Ê∑ªÂä† / ÁßªÈô§ select Ê®°ÂºèÊ†áËÆ∞ÔºåÁî®‰∫éÊ†∑ÂºèÂå∫ÂàÜ
        if (select_on) {
            document.body.classList.add('select-mode')
        } else {
            document.body.classList.remove('select-mode')
        }
    }

    for (let ele of lis) {
        ele = ele.children[1]
        if (ele.id === undefined || ele.id === '' || ele.id[ele.id.length - 1] === '/')
            ele.disabled = true
    }

    // Âú® select Ê®°Âºè‰∏ãÔºåÁÇπÂáªÊï¥Êù°Êñá‰ª∂ÂêçÂå∫ÂüüÔºàÂåÖÂê´Êñá‰ª∂ÂêçÔºâ‰πüËÉΩÂãæÈÄâ / ÂèñÊ∂àÂãæÈÄâ
    let dirItems = document.querySelectorAll('#dir_ul li')

    function isSelectModeOn() {
        // select_on -> ËøõÂÖ•ÈÄâÊã©Ê®°ÂºèÂêéÊñáÂ≠ó‰ºöÂèòÊàê select_off
        return btn_select.innerText === 'select_off'
    }

    for (let li of dirItems) {
        let checkbox = li.querySelector('input[name="cb"]')
        let link = li.querySelector('a.file-name')
        if (!checkbox) continue

        // Êï¥Ë°åÁÇπÂáªÔºàÈô§ÁúüÊ≠£ÁÇπÂáª checkbox Â§ñÔºâÔºåÂú® select Ê®°Âºè‰∏ãÂàáÊç¢ÂãæÈÄâ
        li.addEventListener('click', function (e) {
            if (e.target && e.target.tagName.toLowerCase() === 'input') {
                return
            }
            if (!isSelectModeOn()) {
                return
            }
            if (checkbox.disabled) {
                return
            }
            e.preventDefault()
            e.stopPropagation()
            checkbox.checked = !checkbox.checked
        }, false)

        // Êñá‰ª∂ÂêçÁÇπÂáªÂú® select Ê®°Âºè‰∏ãÂêåÊ†∑Âè™ÂàáÊç¢ÂãæÈÄâÔºå‰∏çË∑≥ËΩ¨
        if (link) {
            link.addEventListener('click', function (e) {
                if (!isSelectModeOn()) {
                    // Èùû select Ê®°ÂºèÔºåÊ≠£Â∏∏Ë∑≥ËΩ¨
                    return
                }
                // select Ê®°Âºè‰∏ãÔºåÊó†ËÆ∫ÊòØÊñá‰ª∂ËøòÊòØÁõÆÂΩïÔºåÈÉΩ‰∏çË∑≥ËΩ¨
                e.preventDefault()
                e.stopPropagation()
                // ‰ªÖÂØπÂèØÁî®ÁöÑ checkbox ÂÅöÈÄâ‰∏≠ÂàáÊç¢ÔºàÁõÆÂΩïÁöÑ checkbox ÊòØ disabledÔºå‰∏ç‰ºöË¢´ÂàáÊç¢Ôºâ
                if (checkbox.disabled) {
                    return
                }
                checkbox.checked = !checkbox.checked
            }, false)
        }
    }

    for (let ele of btns_mode) {
        ele.onclick = function () {
            let mode_n = ele.id.split('_')[1]

            let url = new URL(window.location.href)
            url.searchParams.set('mode', mode_n)
            if (mode_n === 'normal')
                url.searchParams.delete('mode')

            for (let i of btns_mode)
                i.disabled = false
            ele.disabled = true
            window.history.replaceState('', document.title, url.pathname + url.search);

            let arg = (get_mode() === 'normal') ? '' : ('?mode=' + mode_n)
            for (let a of links)
                a.href = a.getAttribute('href').split('?')[0] + arg
        }
    }

    let select_all_check_box = 0; // 0: undefined; 1: select_all; -1: cancel_all
    btn_select_all.onclick = function () {
        if (select_all_check_box !== 1) {
            select_all_check_box = 1
        } else {
            select_all_check_box = -1
        }
        btn_select_all.innerText = select_all_check_box !== 1 ? 'select_all' : 'cancel_all'
        for (let ele of lis) {
            ele = ele.children[1]
            ele.checked = (!ele.disabled) && (select_all_check_box === 1)
        }
    }

    // for batch down
    function download(name, href) {
        console.log('download: ', href);
        let a = document.createElement("a");
        let e = document.createEvent("MouseEvents");
        e.initEvent("click", false, false);
        a.href = href;
        a.download = name;
        a.dispatchEvent(e);
        a = undefined
    }

    btn_batch_down.onclick = function () {
        let url = window.location.origin + window.location.pathname;
        url += url.endsWith('/') ? '' : '/'
        let empty = true;
        for (let ele of lis) {
            ele = ele.children[1]
            if (ele.checked) {
                let h = url + ele.id + '?mode=down';
                download(ele.id, h);
                empty = false;
            }
        }
        if (empty) {
            alert('please check one at least for download')
        }
    }


    let modeSet = new Set(['txt', 'play', 'down', 'normal'])

    function get_mode() {
        let url = new URL(window.location.href)
        let ret = url.searchParams.get("mode")
        if (ret === null || ret === undefined || ret === '' || !modeSet.has(ret))
            ret = 'normal'
        return ret
    }

    // check mode to set link
    document.getElementById('btn_' + get_mode()).disabled = true
</script>

{% if upload %}
    <div class="card" style="margin-top: 18px;">
        <div class="card-header">
            <div class="card-title">Upload files</div>
        </div>
        <div style="display:flex; align-items:center; justify-content: space-between; gap:12px; flex-wrap: wrap;">
            <div>
                <a href="javascript:void(0);" class="file">
                    ÈÄâÊã©Êñá‰ª∂
                    <input type="file" name="file" id="file" multiple="multiple"/>
                </a>
                <div class="upload-tip">ÊîØÊåÅÂ§öÊñá‰ª∂‰∏ä‰º†</div>
            </div>
            <a href="javascript:void(0);" class="file" style="background:#22c55e;" onclick="upload_file()">‰∏ä‰º†</a>
        </div>
        <ul id="file_ul"></ul>
    </div>
    {#    the js for upload #}
    <script type="text/javascript">
        let file_ele = document.getElementById('file');
        let file_ul = document.getElementById('file_ul');
        let empty_file_list = file_ele.files;
        let file_map = new Map();
        file_ele.addEventListener('change', function () {
            let tmp_files = file_ele.files;
            if (tmp_files.length > 0) {
                for (let i = 0; i < tmp_files.length; i++) {
                    file_map.set(ftoa(tmp_files[i]), {'fobj': tmp_files[i], 'state': 0}); // state completed=1,wait=0,error=-1Ôºåing=2
                }
            }
            file_ele.files = empty_file_list;
            update_ul();
        });

        function del_file(key) {//key is the base64 of file object
            file_map.set(key, '');
            update_ul();
        }

        function update_ul() {
            let str = '';
            for (let pair of file_map) {
                let k = pair[0];
                let f = pair[1];
                if (!is_empty(f)) {
                    let fobj = f['fobj'];
                    let state = f['state'];
                    if (state === 1) { // completed
                        str += '<li id=li_\'' + k + '\'>' +
                            '<div style="margin-right:35px">' +
                            '<a style="margin-right:15px;" href="javascript:void(0);" onclick="del_file(\'' + k + '\')"> remove</a>' +
                            '<span>' + fobj.name + '</span>' +
                            '<span style="float:right;color:#8ADE1F">completed</span>' +
                            '<div>' +
                            '</li>';
                    } else if (state === 0) { // wait
                        str += '<li id=li_\'' + k + '\'>' +
                            '<div style="margin-right:35px">' +
                            '<a style="margin-right:15px;" href="javascript:void(0);" onclick="del_file(\'' + k + '\')"> remove</a>' +
                            '<span>' + fobj.name + '</span>' +
                            '<span style="float:right;">wait</span>' +
                            '<div>' +
                            '</li>';
                    } else if (state === -1) {  // error
                        str += '<li id=li_\'' + k + '\'>' +
                            '<div style="margin-right:35px">' +
                            '<a style="margin-right:15px;" href="javascript:void(0);" onclick="del_file(\'' + k + '\')"> remove</a>' +
                            '<span>' + fobj.name + '</span>' +
                            '<span style="float:right; color=#FF4326">failed</span>' +
                            '<div>' +
                            '</li>';
                    } else if (state === 2) {// ing
                        str += '<li id=li_\'' + k + '\'>' +
                            '<div style="margin-right:35px">' +
                            '<span style="margin-right:15px; color:#8585FF" > remove</span>' +
                            '<span>' + fobj.name + '</span>' +
                            '<span style="float:right;">' + f['per'] + '% uploading</span>' +
                            '<div style="height:1px;background-color:#8585ff; width:' + f['per'] + '%"><div>' +
                            '<div>' +
                            '</li>';
                    }
                }
            }
            file_ul.innerHTML = str;
        }

        function is_empty(arg) {
            return arg === null || arg === undefined || arg === '';
        }

        function ftoa(f) {
            let s = '';
            for (let i in f) {
                s = s + f[i];
            }
            return window.btoa(window.encodeURIComponent(s));
        }

        function upload_file() {
            if (is_map_empty(file_map) || file_map.size === 0) {
                alert('Please select one file at least');
                return;
            }
            let all_completed = true;
            for (let pair of file_map) {
                all_completed = all_completed && (pair[1]['state'] === 1);
            }
            if (all_completed) {
                alert('All files have uploaded, Please select some file to upload.');
                return;
            }

            let url = window.location.href;
            for (let pair of file_map) {
                let f = pair[1];
                if (is_empty(f) || f['state'] === 1) continue;
                let fobj = f['fobj'];
                let form = new FormData();
                form.append('file', fobj);
                let xhr = new XMLHttpRequest();
                xhr.custom_file_name = fobj.name;
                xhr.custom_file_key = pair[0];
                xhr.upload.custom_file_key = pair[0];
                xhr.open('post', url, true);
                xhr.onload = upload_complete;
                xhr.onerror = upload_error;
                xhr.upload.onprogress = upload_progress;
                xhr.send(form);
            }
        }

        function is_map_empty(map) {
            if (!is_empty(map)) {
                let values_all_empty = true;
                for (let pair of map) {
                    values_all_empty = values_all_empty && (is_empty(pair[1]));
                }
                return values_all_empty;
            }
            return true
        }

        function upload_complete() {
            console.log(this.responseText)
            var obj = JSON.parse(this.responseText);
            if (obj['state'] === 'succeed')
                file_map.get(this.custom_file_key)['state'] = 1;
            else
                file_map.get(this.custom_file_key)['state'] = -1;
            update_ul();
        }

        function upload_error(evt) {
            file_map.get(this.custom_file_key)['state'] = -1;
            update_ul();
            alert('upload error: ' + evt);
        }

        function upload_progress(evt) {
            console.log('upload_progress', evt.lengthComputable);
            let f = file_map.get(this.custom_file_key);
            f['state'] = 2; //ing
            if (evt.lengthComputable)
                f['per'] = Math.round(evt.loaded / evt.total * 100);
            else
                f['per'] = 'unknown';
            update_ul();
        }
    </script>
{% endif %}
</body>
</html>